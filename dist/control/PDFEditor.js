sap.ui.define(["sap/ui/core/Control","sap/base/Log","../pdftron/lib/webviewer.min"],function(e,t,n){"use strict";return e.extend("com.cjastram.ui5.control.PDFEditor",{metadata:{properties:{width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},readonly:{type:"boolean",defaultValue:false},theme:{type:"string",defaultValue:"light"},username:{type:"string"},data:{type:"string",defaultValue:null}},aggregations:{buttons:{type:"com.cjastram.PDFEditor.control.Button",multiple:true,singularName:"button"}},events:{press:{parameters:{name:{type:"string"}}},documentLoaded:{parameters:{}}}},init:function(){this._delayedCalls=[];this._deletedAnnotations=new Map;this._updatedAnnotations=new Map;this._addedAnnotations=new Map},renderer:function(e,t){e.write("<div");e.writeControlData(t);e.addStyle("width",t.getWidth());e.addStyle("height",t.getHeight());e.writeStyles();e.write(">");e.write("</div>")},onAfterRendering:function(){WebViewer({path:"./pdftron/lib",ui:"beta",backendType:"ems",fullAPI:true},document.getElementById(this.getId())).then(function(e){this._setupWebViewer(e)}.bind(this))},setData:function(e){if(e&&e.length>0){var t=new Blob([this.base64ToArrayBuffer(e)],{type:"application/pdf"});this._callOrDelay(function(e){e.loadDocument(t,{})})}},setReadonly:function(e){this._callOrDelay(function(t){t.annotManager.setReadOnly(e)})},setUsername:function(e){if(e&&e.length>0){this._callOrDelay(function(t){t.docViewer.getAnnotationManager().setCurrentUser(e)})}},setTheme:function(e){this._callOrDelay(function(t){t.setTheme(e)})},getPDFMetadata:function(){return this._webViewer.docViewer.getDocument().getMetadata()},getFormFields:function(e,t){var n=[];var a=this._webViewer.annotManager.getFieldManager();a.forEachField(function(a){this._getFields(e,a,n,t)}.bind(this));return n},getAnnotations:function(e,n){var a=[];var i=[];var o=this._webViewer.annotManager.getAnnotationsList();for(var r=0;r<o.length;r++){const s=o[r];if(s.elementName!="text")continue;var n=s.getCustomData("sap");if(n!="add"&&n!="modify")continue;const d={Id:e,AnnotationId:s.Id,InReplyTo:s.InReplyTo,Author:s.Author,State:s.getState(),YPos:s.getY()*100,Content:s.getContents(),PageNr:s.getPageNumber()};switch(n){case"add":i.push(d);break;case"modify":a.push(d);break;default:t.error("Invalid customdata: "+n)}}return{new:i,updated:a,deleted:this._getDeletedAnnotations(e)}},setAnnotationsCustomData:function(e,t){var n=this._webViewer.annotManager.getAnnotationsList();for(var a=0;a<n.length;a++){if(n[a].elementName=="text"){n[a].setCustomData(e,t)}}},_getDeletedAnnotations:function(e){const t=this._deletedAnnotations.keys();var n=[];var a=t.next().value;while(a){n.push({id:e,annotationId:a});a=t.next().value}this._deletedAnnotations=new Map;return n},_getFields:function(e,t,n,a){if(t.children.length>0){t.children.forEach(function(t){this._getFields(e,t,n)}.bind(this))}else{if(!a||t.IsModified){n.push({Id:e,Name:t.name,Value:t.value})}}},_callOrDelay:function(e){if(this._webViewer){e(this._webViewer)}else{this._delayedCalls.push(e)}},_setupAnnotationEvents:function(){const{docViewer:e,annotManager:t}=this._webViewer;e.on("documentLoaded",()=>{var e=[];var t=[];this.fireDocumentLoaded();const n=this.getAggregation("buttons");for(var a=0;a<n.length;a++){const i=n[a].getProperty("name");if(n[a].getProperty("disabled")){e.push(i)}else{t.push(i)}}this._webViewer.disableElements(e);this._webViewer.enableElements(t)});t.on("annotationChanged",(e,t)=>{e.forEach(e=>{if(e.elementName=="text"){var n=e.getCustomData("sap");switch(t){case"add":if(!n){e.setCustomData("sap","add")}break;case"delete":if(n!="add"){this._deletedAnnotations.set(e.Id,t)}break;case"modify":if(n!="add"){e.setCustomData("sap","modify")}break}}})})},_createButtons:function(){const e=this.getAggregation("buttons");if(e){this._webViewer.setHeaderItems(t=>{for(var n=0;n<e.length;n++){var a=e[n];const i=a.getProperty("name");const o=a.getProperty("type");a._instance=this._webViewer;switch(o){case"divider":t.push({type:o});break;case"actionButton":t.push({type:o,title:a.getProperty("title"),dataElement:i,img:a.getProperty("image"),onClick:()=>{this.firePress({name:i})}});break}}})}},_processDelayedFunctions:function(){for(var e=0;e<this._delayedCalls.length;e++){this._delayedCalls[e](this._webViewer);delete this._delayedCalls[e]}this._delayedCalls=[]},_setupWebViewer(e){t.info("_setupWebViewer");this._webViewer=e;this._setupAnnotationEvents();this._processDelayedFunctions();this._createButtons()},getFileData:function(e){return this._webViewer.annotManager.exportAnnotations().then(function(t){return this._webViewer.docViewer.getDocument().getFileData({xfdfString:t,flatten:e})}.bind(this))},base64ToArrayBuffer:function(e){let t=window.atob(e);let n=t.length;var a=new Uint8Array(n);for(var i=0;i<n;i++){a[i]=t.charCodeAt(i)}return a.buffer},arrayBufferToBase64:function(e){var t="";const n=new Uint8Array(e);const a=n.byteLength;for(var i=0;i<a;i++){t+=String.fromCharCode(n[i])}return window.btoa(t)}})});