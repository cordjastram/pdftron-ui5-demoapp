sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/m/MessageToast","sap/ui/core/Fragment","sap/base/Log","./Util","../control/PDFDataService"],function(e,t,i,o,n,a,s,r){"use strict";return e.extend("com.cjastram.PDFEditor.controller.Object",{onInit:function(){var e,i=new t({busy:true,delay:0});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);e=this.getView().getBusyIndicatorDelay();this.setModel(i,"objectView");this.getOwnerComponent().getModel().metadataLoaded().then(function(){i.setProperty("/delay",e)})},onPdfEditorButtonPress:function(e){const t=e.getParameter("name");const i=e.getSource();switch(t){case"btnSave":this.showSaveFileDialog(i);break;case"btnInfo":this.showFileInfoDialog(i);break}},onDocumentLoaded:function(e){o.show("Document loaded!")},onNavBack:function(){var e=i.getInstance().getPreviousHash();if(e!==undefined){history.go(-1)}else{this.getRouter().navTo("worklist",{},true)}},closeSaveDialog:function(){this._saveFileDialog.close()},closeInfoDialog:function(){this._fileInfoDialog.close()},saveFile:function(){this.closeSaveDialog();const e=this._saveFileDialog.getModel();const t=e.getProperty("/PdfEditor");const i=e.getProperty("/FlattenFile");const n=e.getProperty("/Description");const a=this.getModel();const l=a.getObject(this._sObjectPath);const d=t.getAnnotations(l.Id);t.setAnnotationsCustomData("sap","saved");const c=t.getFormFields(l.Id,l.FormImported);t.getFileData(i).then(function(e){var t={Id:l.Id,Cdate:l.Cdate,Description:n,FileName:l.FileName,Flattened:i,FormImported:true,Data:s.arrayBufferToBase64(e)};var h=function(){r.handleFormFields(a,c,l.FormImported);r.handleAnnotations(a,d);a.submitChanges()};var g=function(){o.show("Document update failed! ")};r.updateFile(a,t,h,g)})},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var i=e.getParameter("query");if(i&&i.length>0){t=[new Filter("FileName",FilterOperator.Contains,i)]}this._applySearch(t)}},showSaveFileDialog:function(e){if(this._sObjectPath){var i=new t;i.setProperty("/Description",this.getView().getBindingContext().getObject().Description);i.setProperty("/PdfEditor",e);if(!this._saveFileDialog){n.load({name:"com.cjastram.PDFEditor.view.FileSaveDialog",controller:this}).then(function(e){this._saveFileDialog=e;this.getView().addDependent(this._saveFileDialog);this._saveFileDialog.setModel(i);this._saveFileDialog.open()}.bind(this))}else{this._saveFileDialog.setModel(i);this._saveFileDialog.open()}}},showFileInfoDialog:function(e){if(this._sObjectPath){e.getPDFMetadata().then(function(e){var i=new t;i.setProperty("/Application",e.application);i.setProperty("/Keywords",e.keywords);i.setProperty("/Creator",e.creator);i.setProperty("/Header",e.header);i.setProperty("/Producer",e.producer);i.setProperty("/Title",e.title);i.setProperty("/Subject",e.subject);if(!this._fileInfoDialog){n.load({name:"com.cjastram.PDFEditor.view.FileInfoDialog",controller:this}).then(function(e){this._fileInfoDialog=e;this.getView().addDependent(this._fileInfoDialog);this._fileInfoDialog.setModel(i);this._fileInfoDialog.open()}.bind(this))}else{this._fileInfoDialog.setModel(i);this._fileInfoDialog.open()}}.bind(this))}},_onObjectMatched:function(e){var t=e.getParameter("arguments").objectId;this.getModel().metadataLoaded().then(function(){var e=this.getModel().createKey("/PdfFiles",{Id:t});this._sObjectPath=e;this._bindView(e)}.bind(this))},_bindView:function(e){var t=this.getModel("objectView"),i=this.getModel();this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){i.metadataLoaded().then(function(){t.setProperty("/busy",true)})},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),i=e.getElementBinding();if(!i.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var o=e.getBindingContext().getObject();t.setProperty("/busy",false)}})});